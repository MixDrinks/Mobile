name: Publish ios build

on:
  push:
    branches:
      - prepare_ios_ci

jobs:
  deploy_ios:
    env:
      MIXDRINKS_MOBILE_APP_VERSION_NAME: "1.2.0"
      MIXDRINKS_MOBILE_APP_VERSION_CODE: 10
    runs-on: macos-12
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: Build xcworkspace
        run: ./gradlew podInstall

      - name: Build IOS App
        uses: yukiarrr/ios-build-action@v1.4.0
        with:
            project-path: iosApp/iosApp.xcodeproj
            p12-base64: ${{ secrets.MIXDRINKS_IOS_P12_BASE64 }}
            mobileprovision-base64: ${{ secrets.MIXDRINKS_IOS_BUILD_PROVISION_PROFILE_BASE64 }}
            code-signing-identity: "iPhone Distribution"
            team-id: "9LJW42P73L"
            certificate-password: ${{ secrets.MIXDRINKS_IOS_CERTIFICATE_PASSWORD }}
            workspace-path: iosApp/iosApp.xcworkspace
            export-method: "ad-hoc"
      - name: Upload Artifact
        uses: actions/upload-artifact@v2
        with:
            name: IOS IPA
            path: "output.ipa"
      - name: 'Upload app to TestFlight'
        uses: apple-actions/upload-testflight-build@v1
        with:
            app-path: 'output.ipa'
            issuer-id: ${{ secrets.MIXDRINKS_IOS_APPSTORE_ISSUER_ID }}
            api-key-id: ${{ secrets.MIXDRINKS_IOS_APPSTORE_API_KEY_ID }}
            api-private-key: ${{ secrets.MIXDRINKS_IOS_APPSTORE_API_PRIVATE_KEY }}
